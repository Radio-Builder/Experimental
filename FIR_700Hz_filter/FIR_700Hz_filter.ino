#include <driver/i2s.h>
#include <math.h>
#include <freertos/FreeRTOS.h>
#include <freertos/task.h>


#include <driver/i2s.h>
#include <math.h>

#define NUM_TAPS 1024  // Number of filter taps
#define I2S_WS    33   // Word Select (LRCLK)
#define I2S_BCK   5    // Bit Clock (SCLK)
#define I2S_DOUT  25   // Serial Data Out (SDOUT)
#define I2S_DIN   26   // Serial Data In (SDIN)
#define I2S_MCLK   0   // Master Clock (MCLK) on GPIO 0


float apply_fir_filter(float input_sample);

// Define the I2S task function
void i2s_task(void *param) {
    // Create buffers for I2S read and write
    const int buffer_size = 512;
    char i2s_read_buffer[buffer_size];
    size_t bytes_read, bytes_written;

    while (1) {
        // Read data from I2S input (e.g., microphone or ADC)
        i2s_read(I2S_NUM_0, &i2s_read_buffer, buffer_size, &bytes_read, portMAX_DELAY);

        // Cast buffer to int16_t for 16-bit samples
        int16_t* samples = (int16_t*) i2s_read_buffer;
        int num_samples = bytes_read / sizeof(int16_t);  // Total number of samples

        // Apply the FIR filter to only the left channel (skip right channel samples)
        for (int i = 0; i < num_samples; i += 2) {  // Step by 2 to only process left channel
            float input = (float)samples[i];  // Process only the left channel sample

            // Apply the FIR filter
            float filtered_sample = apply_fir_filter(input);

            // Clipping to avoid overflow
            if (filtered_sample > 32767) {
                filtered_sample = 32767;
            } else if (filtered_sample < -32768) {
                filtered_sample = -32768;
            }

            // Set the processed left channel sample
            samples[i] = (int16_t)filtered_sample;

            // Optionally: Copy left channel sample to the right channel for symmetrical output
            samples[i + 1] = (int16_t)filtered_sample;  // Copy the same filtered left sample to right channel
        }

        // Write the filtered data back to I2S output (e.g., DAC or speaker)
        i2s_write(I2S_NUM_0, &i2s_read_buffer, bytes_read, &bytes_written, portMAX_DELAY);
    }

    vTaskDelete(NULL);  // Delete the task if it exits the loop
}

float fir_coefficients[NUM_TAPS] = {
    1.56048304e-05,     5.66541218e-05,     9.56158889e-05,     1.30958244e-04,     1.61282894e-04,     1.85379233e-04,     2.02271594e-04,     2.11257879e-04,     2.11938053e-04,     2.04231394e-04, 
    1.88381759e-04,     1.64950593e-04,     1.34797839e-04,     9.90513620e-05,     5.90659313e-05,     1.63732055e-05,     -2.73754974e-05,     -7.04715636e-05,     -1.11214292e-04,     -1.47976522e-04, 
    -1.79268206e-04,     -2.03795512e-04,     -2.20513149e-04,     -2.28667854e-04,     -2.27831269e-04,     -2.17920811e-04,     -1.99207558e-04,     -1.72310678e-04,     -1.38178373e-04,     -9.80558831e-05, 
    -5.34415453e-05,     -6.03239160e-06,     4.23388026e-05,     8.97727594e-05,     1.34376678e-04,     1.74338218e-04,     2.07997655e-04,     2.33915395e-04,     2.50932153e-04,     2.58219340e-04, 
    2.55317500e-04,     2.42161094e-04,     2.19088384e-04,     1.86835739e-04,     1.46516259e-04,     9.95832418e-05,     4.77795760e-05,     -6.92523711e-06,     -6.24082517e-05,     -1.16473785e-04, 
    -1.66938667e-04,     -2.11718798e-04,     -2.48913628e-04,     -2.76885214e-04,     -2.94328608e-04,     -3.00330628e-04,     -2.94414406e-04,     -2.76567672e-04,     -2.47253253e-04,     -2.07400978e-04, 
    -1.58380891e-04,     -1.01958385e-04,     -4.02326241e-05,     2.44396873e-05,     8.95325157e-05,     1.52447454e-04,     2.10615776e-04,     2.61601653e-04,     3.03202439e-04,     3.33541966e-04, 
    3.51152960e-04,     3.55045036e-04,     3.44755202e-04,     3.20378451e-04,     2.82576735e-04,     2.32565451e-04,     1.72077443e-04,     1.03305426e-04,     2.88246268e-05,     -4.85017324e-05, 
    -1.25630718e-04,     -1.99457724e-04,     -2.66939750e-04,     -3.25219102e-04,     -3.71742533e-04,     -4.04370945e-04,     -4.21474992e-04,     -4.22012425e-04,     -4.05583600e-04,     -3.72462422e-04, 
    -3.23600884e-04,     -2.60606388e-04,     -1.85692134e-04,     -1.01601925e-04,     -1.15118360e-05,     8.10878390e-05,     1.72526051e-04,     2.59094847e-04,     3.37198038e-04,     4.03498784e-04, 
    4.55060112e-04,     4.89472521e-04,     5.04963206e-04,     5.00482070e-04,     4.75760502e-04,     4.31339914e-04,     3.68568193e-04,     2.89563471e-04,     1.97145942e-04,     9.47397468e-05, 
    -1.37517755e-05,     -1.24093014e-04,     -2.31879754e-04,     -3.32713317e-04,     -4.22378369e-04,     -4.97017261e-04,     -5.53293765e-04,     -5.88539335e-04,     -6.00875568e-04,     -5.89307393e-04, 
    -5.53782540e-04,     -4.95214160e-04,     -4.15464859e-04,     -3.17291950e-04,     -2.04255314e-04,     -8.05907745e-05,     4.89466074e-05,     1.79263616e-04,     3.05127524e-04,     4.21374609e-04, 
    5.23120299e-04,     6.05962460e-04,     6.66169435e-04,     7.00844880e-04,     7.08062232e-04,     6.86962719e-04,     6.37812170e-04,     5.62013470e-04,     4.62073245e-04,     3.41523167e-04, 
    2.04798163e-04,     5.70755609e-05,     -9.59190696e-05,     -2.48132210e-04,     -3.93420394e-04,     -5.25796626e-04,     -6.39675399e-04,     -7.30106333e-04,     -7.92986746e-04,     -8.25244113e-04, 
    -8.24980424e-04,     -7.91571834e-04,     -7.25718698e-04,     -6.29442983e-04,     -5.06032160e-04,     -3.59930794e-04,     -1.96583236e-04,     -2.22328595e-05,     1.56314868e-04,     3.31956539e-04, 
    4.97572008e-04,     6.46311563e-04,     7.71877539e-04,     8.68788850e-04,     9.32617420e-04,     9.60186385e-04,     9.49721361e-04,     9.00947759e-04,     8.15129235e-04,     6.95044642e-04, 
    5.44903299e-04,     3.70200897e-04,     1.77520818e-04,     -2.57120739e-05,     -2.31516033e-04,     -4.31664588e-04,     -6.18014098e-04,     -7.82833712e-04,     -9.19124421e-04,     -1.02091409e-03, 
    -1.08351611e-03,     -1.10374059e-03,     -1.08004867e-03,     -1.01264281e-03,     -9.03488278e-04,     -7.56263758e-04,     -5.76241952e-04,     -3.70103781e-04,     -1.45692617e-04,     8.82825325e-05, 
    3.22583702e-04,     5.47807570e-04,     7.54761700e-04,     9.34838429e-04,     1.08037123e-03,     1.18495886e-03,     1.24374368e-03,     1.25363210e-03,     1.21344741e-03,     1.12400767e-03, 
    9.88124311e-04,     8.10520306e-04,     5.97669953e-04,     3.57565463e-04,     9.94187155e-05,     -1.66690818e-04,     -4.30208554e-04,     -6.80522465e-04,     -9.07389429e-04,     -1.10135318e-03, 
    -1.25413686e-03,     -1.35899389e-03,     -1.41100241e-03,     -1.40729059e-03,     -1.34718253e-03,     -1.23225792e-03,     -1.06632159e-03,     -8.55282911e-04,     -6.06948706e-04,     -3.30736618e-04, 
    -3.73194732e-05,     2.61786037e-04,     5.54670551e-04,     8.29505462e-04,     1.07501978e-03,     1.28096126e-03,     1.43852290e-03,     1.54071725e-03,     1.58268260e-03,     1.56190771e-03, 
    1.47836513e-03,     1.33454618e-03,     1.13539507e-03,     8.88143369e-04,     6.02050112e-04,     2.88056864e-04,     -4.16295839e-05,     -3.74010972e-04,     -6.95809438e-04,     -9.93997370e-04, 
    -1.25632411e-03,     -1.47181825e-03,     -1.63124496e-03,     -1.72749934e-03,     -1.75591909e-03,     -1.71450296e-03,     -1.60402488e-03,     -1.42803789e-03,     -1.19276638e-03,     -9.06889510e-04, 
    -5.81223225e-04,     -2.28312375e-04,     1.38051683e-04,     5.03369520e-04,     8.53007116e-04,     1.17278170e-03,     1.44953653e-03,     1.67168127e-03,     1.82967598e-03,     1.91643828e-03, 
    1.92765666e-03,     1.86199610e-03,     1.72118641e-03,     1.50998850e-03,     1.23603845e-03,     9.09574187e-04,     5.43054594e-04,     1.50684956e-04,     -2.52133089e-04,     -6.49405889e-04, 
    -1.02518266e-03,     -1.36419577e-03,     -1.65248062e-03,     -1.87795015e-03,     -2.03090015e-03,     -2.10442444e-03,     -2.09472225e-03,     -2.00128411e-03,     -1.82694774e-03,     -1.57782000e-03, 
    -1.26306687e-03,     -8.94578320e-04,     -4.86520360e-04,     -5.47909872e-05,     3.83599025e-04,     8.11196425e-04,     1.21080044e-03,     1.56615473e-03,     1.86260848e-03,     2.08771977e-03, 
    2.23177638e-03,     2.28821231e-03,     2.25390218e-03,     2.12932053e-03,     1.91855829e-03,     1.62919426e-03,     1.27202551e-03,     8.60666016e-04,     4.11028461e-04,     -5.92911345e-05, 
    -5.31702153e-04,     -9.87354538e-04,     -1.40789128e-03,     -1.77618819e-03,     -2.07705112e-03,     -2.29784222e-03,     -2.42900957e-03,     -2.46449778e-03,     -2.40202229e-03,     -2.24319493e-03, 
    -1.99349436e-03,     -1.66208133e-03,     -1.26146464e-03,     -8.07030032e-04,     -3.16449501e-04,     1.91006032e-04,     6.95224197e-04,     1.17604886e-03,     1.61408644e-03,     1.99148849e-03, 
    2.29267908e-03,     2.50499719e-03,     2.61922770e-03,     2.62999880e-03,     2.53602864e-03,     2.34021025e-03,     2.04952981e-03,     1.67482041e-03,     1.23035965e-03,     7.33326099e-04, 
    2.03135226e-04,     -3.39319541e-04,     -8.72490891e-04,     -1.37503434e-03,     -1.82666349e-03,     -2.20896950e-03,     -2.50617169e-03,     -2.70576862e-03,     -2.79906281e-03,     -2.78153709e-03, 
    -2.65306649e-03,     -2.41795574e-03,     -2.08479982e-03,     -1.66617174e-03,     -1.17814875e-03,     -6.39694951e-04,     -7.19238573e-05,     5.02730306e-04,     1.06140004e-03,     1.58169557e-03, 
    2.04260315e-03,     2.42533451e-03,     2.71409306e-03,     2.89672574e-03,     2.96523342e-03,     2.91611862e-03,     2.75055537e-03,     2.47437340e-03,     2.09785587e-03,     1.63535775e-03, 
    1.10475864e-03,     5.26771246e-04,     -7.58680534e-05,     -6.79294664e-04,     -1.25946207e-03,     -1.79310133e-03,     -2.25865548e-03,     -2.63715126e-03,     -2.91297282e-03,     -3.07450599e-03, 
    -3.11462631e-03,     -3.03101052e-03,     -2.82625799e-03,     -2.50781588e-03,     -2.08771022e-03,     -1.58209221e-03,     -1.01061701e-03,     -3.95678950e-04,     2.38467201e-04,     8.66664273e-04, 
    1.46385216e-03,     2.00606896e-03,     2.47141376e-03,     2.84093225e-03,     3.09938944e-03,     3.23589779e-03,     3.24437504e-03,     3.12381232e-03,     2.87834096e-03,     2.51709424e-03, 
    2.05386852e-03,     1.50659633e-03,     8.96651462e-04,     2.48013148e-04,     -4.13678089e-04,     -1.06213560e-03,     -1.67147252e-03,     -2.21723685e-03,     -2.67739408e-03,     -3.03321803e-03, 
    -3.27005360e-03,     -3.37792057e-03,     -3.35193337e-03,     -3.19251932e-03,     -2.90542562e-03,     -2.50151389e-03,     -1.99634952e-03,     -1.40960135e-03,     -7.64274843e-04,     -8.58086679e-05, 
    5.98929743e-04,     1.26270995e-03,     1.87902323e-03,     2.42314301e-03,     2.87311841e-03,     3.21066116e-03,     3.42188961e-03,     3.49790001e-03,     3.43514105e-03,     3.23557636e-03, 
    2.90662732e-03,     2.46089784e-03,     1.91569115e-03,     1.29233725e-03,     6.15357067e-04,     -8.85037518e-05,     -7.91333361e-04,     -1.46516255e-03,     -2.08307976e-03,     -2.62030778e-03, 
    -3.05519888e-03,     -3.37010854e-03,     -3.55211221e-03,     -3.59353614e-03,     -3.49228035e-03,     -3.25192025e-03,     -2.88158206e-03,     -2.39559636e-03,     -1.81294285e-03,     -1.15650796e-03, 
    -4.52184290e-04,     2.72152586e-04,     9.87749391e-04,     1.66611867e-03,     2.28017495e-03,     2.80531816e-03,     3.22042089e-03,     3.50867981e-03,     3.65829686e-03,     3.66296255e-03, 
    3.52212162e-03,     3.24100978e-03,     2.83045962e-03,     2.30648266e-03,     1.68964398e-03,     1.00425354e-03,     2.77406409e-04,     -4.62090488e-04,     -1.18486219e-03,     -1.86213482e-03, 
    -2.46688325e-03,     -2.97491155e-03,     -3.36582279e-03,     -3.62383947e-03,     -3.73844132e-03,     -3.70479476e-03,     -3.52395644e-03,     -3.20284225e-03,     -2.75396272e-03,     -2.19493480e-03, 
    -1.54778917e-03,     -8.38100411e-04,     -9.39743154e-05,     6.55067321e-04,     1.37926023e-03,     2.04978272e-03,     2.63990492e-03,     3.12605648e-03,     3.48876974e-03,     3.71346079e-03, 
    3.79101688e-03,     3.71816658e-03,     3.49761753e-03,     3.13795602e-03,     2.65331225e-03,     2.06280405e-03,     1.38978132e-03,     6.60900896e-04,     -9.49313762e-05,     -8.47709239e-04, 
    -1.56751963e-03,     -2.22573369e-03,     -2.79614766e-03,     -3.25602814e-03,     -3.58701984e-03,     -3.77587970e-03,     -3.81500768e-03,     -3.70275320e-03,     -3.44348464e-03,     -3.04741905e-03, 
    -2.53021874e-03,     -1.91237072e-03,     -1.21837352e-03,     -4.75763848e-04,     2.85978158e-04,     1.03660162e-03,     1.74628863e-03,     2.38684114e-03,     2.93280356e-03,     3.36247640e-03, 
    3.65878044e-03,     3.80993697e-03,     3.80993697e-03,     3.65878044e-03,     3.36247640e-03,     2.93280356e-03,     2.38684114e-03,     1.74628863e-03,     1.03660162e-03,     2.85978158e-04, 
    -4.75763848e-04,     -1.21837352e-03,     -1.91237072e-03,     -2.53021874e-03,     -3.04741905e-03,     -3.44348464e-03,     -3.70275320e-03,     -3.81500768e-03,     -3.77587970e-03,     -3.58701984e-03, 
    -3.25602814e-03,     -2.79614766e-03,     -2.22573369e-03,     -1.56751963e-03,     -8.47709239e-04,     -9.49313762e-05,     6.60900896e-04,     1.38978132e-03,     2.06280405e-03,     2.65331225e-03, 
    3.13795602e-03,     3.49761753e-03,     3.71816658e-03,     3.79101688e-03,     3.71346079e-03,     3.48876974e-03,     3.12605648e-03,     2.63990492e-03,     2.04978272e-03,     1.37926023e-03, 
    6.55067321e-04,     -9.39743154e-05,     -8.38100411e-04,     -1.54778917e-03,     -2.19493480e-03,     -2.75396272e-03,     -3.20284225e-03,     -3.52395644e-03,     -3.70479476e-03,     -3.73844132e-03, 
    -3.62383947e-03,     -3.36582279e-03,     -2.97491155e-03,     -2.46688325e-03,     -1.86213482e-03,     -1.18486219e-03,     -4.62090488e-04,     2.77406409e-04,     1.00425354e-03,     1.68964398e-03, 
    2.30648266e-03,     2.83045962e-03,     3.24100978e-03,     3.52212162e-03,     3.66296255e-03,     3.65829686e-03,     3.50867981e-03,     3.22042089e-03,     2.80531816e-03,     2.28017495e-03, 
    1.66611867e-03,     9.87749391e-04,     2.72152586e-04,     -4.52184290e-04,     -1.15650796e-03,     -1.81294285e-03,     -2.39559636e-03,     -2.88158206e-03,     -3.25192025e-03,     -3.49228035e-03, 
    -3.59353614e-03,     -3.55211221e-03,     -3.37010854e-03,     -3.05519888e-03,     -2.62030778e-03,     -2.08307976e-03,     -1.46516255e-03,     -7.91333361e-04,     -8.85037518e-05,     6.15357067e-04, 
    1.29233725e-03,     1.91569115e-03,     2.46089784e-03,     2.90662732e-03,     3.23557636e-03,     3.43514105e-03,     3.49790001e-03,     3.42188961e-03,     3.21066116e-03,     2.87311841e-03, 
    2.42314301e-03,     1.87902323e-03,     1.26270995e-03,     5.98929743e-04,     -8.58086679e-05,     -7.64274843e-04,     -1.40960135e-03,     -1.99634952e-03,     -2.50151389e-03,     -2.90542562e-03, 
    -3.19251932e-03,     -3.35193337e-03,     -3.37792057e-03,     -3.27005360e-03,     -3.03321803e-03,     -2.67739408e-03,     -2.21723685e-03,     -1.67147252e-03,     -1.06213560e-03,     -4.13678089e-04, 
    2.48013148e-04,     8.96651462e-04,     1.50659633e-03,     2.05386852e-03,     2.51709424e-03,     2.87834096e-03,     3.12381232e-03,     3.24437504e-03,     3.23589779e-03,     3.09938944e-03, 
    2.84093225e-03,     2.47141376e-03,     2.00606896e-03,     1.46385216e-03,     8.66664273e-04,     2.38467201e-04,     -3.95678950e-04,     -1.01061701e-03,     -1.58209221e-03,     -2.08771022e-03, 
    -2.50781588e-03,     -2.82625799e-03,     -3.03101052e-03,     -3.11462631e-03,     -3.07450599e-03,     -2.91297282e-03,     -2.63715126e-03,     -2.25865548e-03,     -1.79310133e-03,     -1.25946207e-03, 
    -6.79294664e-04,     -7.58680534e-05,     5.26771246e-04,     1.10475864e-03,     1.63535775e-03,     2.09785587e-03,     2.47437340e-03,     2.75055537e-03,     2.91611862e-03,     2.96523342e-03, 
    2.89672574e-03,     2.71409306e-03,     2.42533451e-03,     2.04260315e-03,     1.58169557e-03,     1.06140004e-03,     5.02730306e-04,     -7.19238573e-05,     -6.39694951e-04,     -1.17814875e-03, 
    -1.66617174e-03,     -2.08479982e-03,     -2.41795574e-03,     -2.65306649e-03,     -2.78153709e-03,     -2.79906281e-03,     -2.70576862e-03,     -2.50617169e-03,     -2.20896950e-03,     -1.82666349e-03, 
    -1.37503434e-03,     -8.72490891e-04,     -3.39319541e-04,     2.03135226e-04,     7.33326099e-04,     1.23035965e-03,     1.67482041e-03,     2.04952981e-03,     2.34021025e-03,     2.53602864e-03, 
    2.62999880e-03,     2.61922770e-03,     2.50499719e-03,     2.29267908e-03,     1.99148849e-03,     1.61408644e-03,     1.17604886e-03,     6.95224197e-04,     1.91006032e-04,     -3.16449501e-04, 
    -8.07030032e-04,     -1.26146464e-03,     -1.66208133e-03,     -1.99349436e-03,     -2.24319493e-03,     -2.40202229e-03,     -2.46449778e-03,     -2.42900957e-03,     -2.29784222e-03,     -2.07705112e-03, 
    -1.77618819e-03,     -1.40789128e-03,     -9.87354538e-04,     -5.31702153e-04,     -5.92911345e-05,     4.11028461e-04,     8.60666016e-04,     1.27202551e-03,     1.62919426e-03,     1.91855829e-03, 
    2.12932053e-03,     2.25390218e-03,     2.28821231e-03,     2.23177638e-03,     2.08771977e-03,     1.86260848e-03,     1.56615473e-03,     1.21080044e-03,     8.11196425e-04,     3.83599025e-04, 
    -5.47909872e-05,     -4.86520360e-04,     -8.94578320e-04,     -1.26306687e-03,     -1.57782000e-03,     -1.82694774e-03,     -2.00128411e-03,     -2.09472225e-03,     -2.10442444e-03,     -2.03090015e-03, 
    -1.87795015e-03,     -1.65248062e-03,     -1.36419577e-03,     -1.02518266e-03,     -6.49405889e-04,     -2.52133089e-04,     1.50684956e-04,     5.43054594e-04,     9.09574187e-04,     1.23603845e-03, 
    1.50998850e-03,     1.72118641e-03,     1.86199610e-03,     1.92765666e-03,     1.91643828e-03,     1.82967598e-03,     1.67168127e-03,     1.44953653e-03,     1.17278170e-03,     8.53007116e-04, 
    5.03369520e-04,     1.38051683e-04,     -2.28312375e-04,     -5.81223225e-04,     -9.06889510e-04,     -1.19276638e-03,     -1.42803789e-03,     -1.60402488e-03,     -1.71450296e-03,     -1.75591909e-03, 
    -1.72749934e-03,     -1.63124496e-03,     -1.47181825e-03,     -1.25632411e-03,     -9.93997370e-04,     -6.95809438e-04,     -3.74010972e-04,     -4.16295839e-05,     2.88056864e-04,     6.02050112e-04, 
    8.88143369e-04,     1.13539507e-03,     1.33454618e-03,     1.47836513e-03,     1.56190771e-03,     1.58268260e-03,     1.54071725e-03,     1.43852290e-03,     1.28096126e-03,     1.07501978e-03, 
    8.29505462e-04,     5.54670551e-04,     2.61786037e-04,     -3.73194732e-05,     -3.30736618e-04,     -6.06948706e-04,     -8.55282911e-04,     -1.06632159e-03,     -1.23225792e-03,     -1.34718253e-03, 
    -1.40729059e-03,     -1.41100241e-03,     -1.35899389e-03,     -1.25413686e-03,     -1.10135318e-03,     -9.07389429e-04,     -6.80522465e-04,     -4.30208554e-04,     -1.66690818e-04,     9.94187155e-05, 
    3.57565463e-04,     5.97669953e-04,     8.10520306e-04,     9.88124311e-04,     1.12400767e-03,     1.21344741e-03,     1.25363210e-03,     1.24374368e-03,     1.18495886e-03,     1.08037123e-03, 
    9.34838429e-04,     7.54761700e-04,     5.47807570e-04,     3.22583702e-04,     8.82825325e-05,     -1.45692617e-04,     -3.70103781e-04,     -5.76241952e-04,     -7.56263758e-04,     -9.03488278e-04, 
    -1.01264281e-03,     -1.08004867e-03,     -1.10374059e-03,     -1.08351611e-03,     -1.02091409e-03,     -9.19124421e-04,     -7.82833712e-04,     -6.18014098e-04,     -4.31664588e-04,     -2.31516033e-04, 
    -2.57120739e-05,     1.77520818e-04,     3.70200897e-04,     5.44903299e-04,     6.95044642e-04,     8.15129235e-04,     9.00947759e-04,     9.49721361e-04,     9.60186385e-04,     9.32617420e-04, 
    8.68788850e-04,     7.71877539e-04,     6.46311563e-04,     4.97572008e-04,     3.31956539e-04,     1.56314868e-04,     -2.22328595e-05,     -1.96583236e-04,     -3.59930794e-04,     -5.06032160e-04, 
    -6.29442983e-04,     -7.25718698e-04,     -7.91571834e-04,     -8.24980424e-04,     -8.25244113e-04,     -7.92986746e-04,     -7.30106333e-04,     -6.39675399e-04,     -5.25796626e-04,     -3.93420394e-04, 
    -2.48132210e-04,     -9.59190696e-05,     5.70755609e-05,     2.04798163e-04,     3.41523167e-04,     4.62073245e-04,     5.62013470e-04,     6.37812170e-04,     6.86962719e-04,     7.08062232e-04, 
    7.00844880e-04,     6.66169435e-04,     6.05962460e-04,     5.23120299e-04,     4.21374609e-04,     3.05127524e-04,     1.79263616e-04,     4.89466074e-05,     -8.05907745e-05,     -2.04255314e-04, 
    -3.17291950e-04,     -4.15464859e-04,     -4.95214160e-04,     -5.53782540e-04,     -5.89307393e-04,     -6.00875568e-04,     -5.88539335e-04,     -5.53293765e-04,     -4.97017261e-04,     -4.22378369e-04, 
    -3.32713317e-04,     -2.31879754e-04,     -1.24093014e-04,     -1.37517755e-05,     9.47397468e-05,     1.97145942e-04,     2.89563471e-04,     3.68568193e-04,     4.31339914e-04,     4.75760502e-04, 
    5.00482070e-04,     5.04963206e-04,     4.89472521e-04,     4.55060112e-04,     4.03498784e-04,     3.37198038e-04,     2.59094847e-04,     1.72526051e-04,     8.10878390e-05,     -1.15118360e-05, 
    -1.01601925e-04,     -1.85692134e-04,     -2.60606388e-04,     -3.23600884e-04,     -3.72462422e-04,     -4.05583600e-04,     -4.22012425e-04,     -4.21474992e-04,     -4.04370945e-04,     -3.71742533e-04, 
    -3.25219102e-04,     -2.66939750e-04,     -1.99457724e-04,     -1.25630718e-04,     -4.85017324e-05,     2.88246268e-05,     1.03305426e-04,     1.72077443e-04,     2.32565451e-04,     2.82576735e-04, 
    3.20378451e-04,     3.44755202e-04,     3.55045036e-04,     3.51152960e-04,     3.33541966e-04,     3.03202439e-04,     2.61601653e-04,     2.10615776e-04,     1.52447454e-04,     8.95325157e-05, 
    2.44396873e-05,     -4.02326241e-05,     -1.01958385e-04,     -1.58380891e-04,     -2.07400978e-04,     -2.47253253e-04,     -2.76567672e-04,     -2.94414406e-04,     -3.00330628e-04,     -2.94328608e-04, 
    -2.76885214e-04,     -2.48913628e-04,     -2.11718798e-04,     -1.66938667e-04,     -1.16473785e-04,     -6.24082517e-05,     -6.92523711e-06,     4.77795760e-05,     9.95832418e-05,     1.46516259e-04, 
    1.86835739e-04,     2.19088384e-04,     2.42161094e-04,     2.55317500e-04,     2.58219340e-04,     2.50932153e-04,     2.33915395e-04,     2.07997655e-04,     1.74338218e-04,     1.34376678e-04, 
    8.97727594e-05,     4.23388026e-05,     -6.03239160e-06,     -5.34415453e-05,     -9.80558831e-05,     -1.38178373e-04,     -1.72310678e-04,     -1.99207558e-04,     -2.17920811e-04,     -2.27831269e-04, 
    -2.28667854e-04,     -2.20513149e-04,     -2.03795512e-04,     -1.79268206e-04,     -1.47976522e-04,     -1.11214292e-04,     -7.04715636e-05,     -2.73754974e-05,     1.63732055e-05,     5.90659313e-05, 
    9.90513620e-05,     1.34797839e-04,     1.64950593e-04,     1.88381759e-04,     2.04231394e-04,     2.11938053e-04,     2.11257879e-04,     2.02271594e-04,     1.85379233e-04,     1.61282894e-04, 
    1.30958244e-04,     9.56158889e-05,     5.66541218e-05,     1.56048304e-05, 
};


// Circular buffer for input samples
float input_buffer[NUM_TAPS] = {0};

// Function to apply the FIR filter
float apply_fir_filter(float input_sample) {
    // Shift the buffer (new sample comes in, old sample shifts out)
    for (int i = NUM_TAPS - 1; i > 0; i--) {
        input_buffer[i] = input_buffer[i - 1];
    }
    input_buffer[0] = input_sample;

    // Apply the FIR filter (convolution)
    float output_sample = 0;
    for (int i = 0; i < NUM_TAPS; i++) {
        output_sample += fir_coefficients[i] * input_buffer[i];
    }

    return output_sample;
}

void setup() {
    Serial.begin(115200);

    // I2S configuration for 22.05 kHz sample rate
    i2s_config_t i2s_config = {
        .mode = (i2s_mode_t)(I2S_MODE_MASTER | I2S_MODE_TX | I2S_MODE_RX),  // Master mode, TX and RX
        .sample_rate = 22050,  // Set the sample rate to 22.05 kHz
        .bits_per_sample = I2S_BITS_PER_SAMPLE_16BIT,  // 16-bit per sample
        .channel_format = I2S_CHANNEL_FMT_RIGHT_LEFT,  // Stereo
        .communication_format = I2S_COMM_FORMAT_I2S_MSB,  // I2S communication format
        .intr_alloc_flags = ESP_INTR_FLAG_LEVEL1,  // Interrupt level
        .dma_buf_count = 8,  // Number of DMA buffers
        .dma_buf_len = 64,  // DMA buffer length
        .use_apll = true,  // Use APLL for accurate MCLK
        .tx_desc_auto_clear = true,  // Auto clear TX descriptor
        .fixed_mclk = 0  // No fixed MCLK frequency
    };

    // Pin configuration (without MCLK)
    i2s_pin_config_t pin_config = {
        .bck_io_num = I2S_BCK,    // Bit Clock pin (SCLK)
        .ws_io_num = I2S_WS,      // Word Select pin (LRCLK)
        .data_out_num = I2S_DOUT, // Data Out pin (SDOUT)
        .data_in_num = I2S_DIN    // Data In pin (SDIN)
    };

    // Install and start I2S driver
    i2s_driver_install(I2S_NUM_0, &i2s_config, 0, NULL);
    i2s_set_pin(I2S_NUM_0, &pin_config);
    i2s_set_clk(I2S_NUM_0, 22050, I2S_BITS_PER_SAMPLE_16BIT, I2S_CHANNEL_STEREO);

    // Manually configure MCLK on GPIO 0 using APLL (Audio PLL)
    PIN_FUNC_SELECT(PERIPHS_IO_MUX_GPIO0_U, FUNC_GPIO0_CLK_OUT1);  // Set GPIO0 as CLK_OUT1
    WRITE_PERI_REG(PIN_CTRL, READ_PERI_REG(PIN_CTRL) & 0xFFFFFFF0);  // Set Clock Out Source

    Serial.println("I2S FIR Filter (128 Taps) Initialized with 22.05 kHz.");

        // Create the I2S processing task and pin it to a different core (e.g., core 0)
    xTaskCreatePinnedToCore(
        i2s_task,         // Task function
        "I2S Task",       // Name of the task (for debugging)
        2048,             // Stack size (in bytes)
        NULL,             // Task parameter (not used)
        1,                // Priority of the task
        NULL,             // Task handle (not used)
        0                 // Pin to core 0
    );
}

void loop() {
  // Print "Hello" to the Serial Monitor
    Serial.println("Hello");

    // Wait for 1 second (1000 milliseconds)
    delay(1000);
}

